<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Conversation with AI Summary</title>
<style>
  :root {
    --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --accent:#1f6feb;
    --radius:12px; --shadow:0 6px 18px rgba(35,40,50,0.08);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body { background:var(--bg); margin:24px; color:#111; }
  .container { max-width:820px; margin:0 auto; }
  .conversation { display:flex; flex-direction:column; gap:12px; margin-bottom:16px; }
  .post {
    background:var(--card); border-radius:var(--radius); padding:14px;
    display:flex; gap:12px; box-shadow:var(--shadow); align-items:flex-start;
  }
  .avatar { width:52px; height:52px; border-radius:50%; flex:0 0 52px;
    display:grid; place-items:center; font-weight:700; color:#fff;
  }
  .content { flex:1; }
  .meta { display:flex; gap:8px; align-items:center; font-size:13px; color:var(--muted); }
  .name { font-weight:600; color:#0f1724; }
  .handle { color:var(--muted); }
  .time { color:var(--muted); }
  .text { margin-top:8px; font-size:15px; line-height:1.45; color:#0f1724; white-space:pre-wrap; }
  .actions { margin-top:12px; display:flex; gap:10px; color:var(--muted); font-size:13px; cursor:pointer; }
  .actions .liked { color:#e0245e; }
  .actions .retweeted { color:#17bf63; }
  .ai-summary { background:#fffbea; color:#1f2937; border:1px solid #facc15;
    border-radius:var(--radius); padding:14px 16px; box-shadow:var(--shadow);
  }
  .reply-box { margin-top:12px; display:flex; gap:10px; }
  textarea {
    flex:1; min-height:78px; padding:10px; border-radius:10px;
    border:1px solid #e6edf7; resize:vertical; font-size:14px;
  }
  .submit {
    background:var(--accent); color:white; border:none; padding:8px 14px;
    border-radius:8px; cursor:pointer;
  }
  .show-more {
    background:#e2e8f0; border:none; padding:8px 14px; border-radius:8px;
    cursor:pointer; font-weight:500; color:#1f2937; margin:10px auto;
    display:block;
  }
</style>
</head>
<body>
<div class="container" role="main">
  <h2>Conversation</h2>

  <div id="conversation" class="conversation"></div>

  <button id="showMoreBtn" class="show-more">Show more comments</button>

  <div style="margin-top:18px;">
    <label for="userComment" style="display:block;margin-bottom:8px;font-weight:600">Your comment</label>
    <div class="reply-box">
      <textarea id="userComment" placeholder="Write a reply..."></textarea>
      <button id="submitComment" class="submit">Post comment</button>
    </div>
  </div>
</div>

<script>
// --- Posts data ---
const posts = [
  { id:"p1", avatarLabel:"EW", name:"EcoWarriors", handle:"@EcoWarriors", time:"2h",
    text:`The amount of extra heat humans are adding to the ocean is 14 zettajoules which is equal to 7 atomic bombs detonating every second of every day for a year. Since 1955 oceans have absorbed excess heat enough to boil 60 billion Olympic swimming pools.`, likes:50, retweets:10 },
  { id:"p2", type:"summary" },
  { id:"p3", avatarLabel:"E", name:"Elaine", handle:"@ElaineAZ", time:"1h",
    text:"Extra compared to what?", likes:5, retweets:1 },
  { id:"p4", avatarLabel:"AA", name:"Angry Arizonans", handle:"@AngryAZ", time:"1h",
    text:"The ocean absorbs more than 90% of excess heat from greenhouse gases. It's essentially buffering humanity from the full force of climate change ‚Äî but at an enormous cost to marine life.", likes:8, retweets:2 },
  { id:"p5", avatarLabel:"DZ", name:"DennyZ", handle:"@DennyZ", time:"45m",
    text:"We're way past screwed. Way to go oligarchs. You suck.", likes:4, retweets:0 }
];

// --- Hidden extra comments ---
const moreComments = [
  { id:"p6", avatarLabel:"K", name:"Kai", handle:"@KaiFacts", time:"30m", text:"The numbers are hard to grasp, but it‚Äôs basically unimaginable energy.", likes:3, retweets:1 },
  { id:"p7", avatarLabel:"S", name:"Sam", handle:"@SamSkeptic", time:"25m", text:"Sources? Always these crazy comparisons with bombs.", likes:2, retweets:0 },
  { id:"p8", avatarLabel:"L", name:"Lana", handle:"@LanaOcean", time:"20m", text:"Marine ecosystems are literally collapsing in slow motion. üò¢", likes:7, retweets:2 },
  { id:"p9", avatarLabel:"R", name:"Ravi", handle:"@RaviEarth", time:"10m", text:"We can still mitigate if we stop burning everything.", likes:5, retweets:1 }
];

// Optional avatar colors
const avatarColors = ["#1f6feb","#e0245e","#17bf63","#f59e0b"];
const aiSummaryText = `Human activity has added 14 zettajoules of heat to oceans since 1955 (equal to 7 atomic bombs/second for a year). Replies are sharply divided between those accepting climate science and skeptics denying human causation or questioning the data.`;

// --- Helper functions ---
function initials(label){
  const toks = label?.trim().split(/\s+/);
  return toks?.length>1 ? (toks[0][0]+toks[1][0]).toUpperCase() : label?.slice(0,2).toUpperCase();
}
function escapeHtml(text){
  return String(text)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#039;');
}

// --- Render conversation ---
function renderConversation(containerId, postsArray) {
  const container = document.getElementById(containerId);
  container.innerHTML = "";

  postsArray.forEach((p,index)=>{
    let element;
    if (p.type === "summary") {
      element = document.createElement("div");
      element.className = "ai-summary";
      element.innerHTML = `<strong>AI Summary:</strong><p>${escapeHtml(aiSummaryText)}</p>`;
    } else {
      element = document.createElement("article");
      element.className = "post";
      element.setAttribute("data-post-id", p.id);
      const bgColor = avatarColors[index % avatarColors.length];
      element.innerHTML = `
        <div class="avatar" style="background:${bgColor}">${escapeHtml(initials(p.avatarLabel||p.name))}</div>
        <div class="content">
          <div class="meta">
            <div class="name">${escapeHtml(p.name)}</div>
            <div class="handle">${escapeHtml(p.handle)}</div>
            <div class="time">¬∑ ${escapeHtml(p.time)}</div>
          </div>
          <div class="text">${escapeHtml(p.text)}</div>
          <div class="actions">
            <span class="like-btn" data-liked="false">‚ù§Ô∏è <span class="like-count">${p.likes||0}</span></span>
            <span class="retweet-btn" data-retweeted="false">üîÅ <span class="retweet-count">${p.retweets||0}</span></span>
            <span class="reply-btn">üí¨ Reply</span>
          </div>
        </div>`;
    }
    container.appendChild(element);
  });

  // Like buttons
  container.querySelectorAll(".like-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const postEl = btn.closest(".post");
      const postId = postEl ? postEl.getAttribute("data-post-id") : null;
      const liked = btn.getAttribute("data-liked")==="true";
      const countSpan = btn.querySelector(".like-count");
      let count = parseInt(countSpan.textContent);
      count = liked ? count-1 : count+1;
      countSpan.textContent = count;
      btn.setAttribute("data-liked",!liked);
      btn.classList.toggle("liked",!liked);
      if(window.parent!==window){
        window.parent.postMessage({type:"USER_LIKE",postId,count},"*");
      }
      sendHeightToParent();
    });
  });

  // Retweet buttons
  container.querySelectorAll(".retweet-btn").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const postEl = btn.closest(".post");
      const postId = postEl ? postEl.getAttribute("data-post-id") : null;
      const retweeted = btn.getAttribute("data-retweeted")==="true";
      const countSpan = btn.querySelector(".retweet-count");
      let count = parseInt(countSpan.textContent);
      count = retweeted ? count-1 : count+1;
      countSpan.textContent = count;
      btn.setAttribute("data-retweeted",!retweeted);
      btn.classList.toggle("retweeted",!retweeted);
      if(window.parent!==window){
        window.parent.postMessage({type:"USER_RETWEET",postId,count},"*");
      }
      sendHeightToParent();
    });
  });
}

// --- Initial render ---
renderConversation("conversation", posts);

// --- Show more comments button ---
document.getElementById("showMoreBtn").addEventListener("click", ()=>{
  posts.push(...moreComments);
  renderConversation("conversation", posts);
  document.getElementById("showMoreBtn").style.display = "none";

  // ‚úÖ Track button click for Qualtrics
  if(window.parent!==window){
    window.parent.postMessage({type:"USER_SHOW_MORE_CLICKED"},"*");
  }

  sendHeightToParent();
});

// --- User posting comment ---
document.getElementById("submitComment").addEventListener("click",()=>{
  const txt = document.getElementById("userComment").value.trim();
  if(!txt){alert("Please write something before posting."); return;}
  const newPost = { id:"u"+Date.now(), avatarLabel:"Y", name:"You", handle:"@you", time:"now", text:txt, likes:0, retweets:0 };
  posts.push(newPost);
  renderConversation("conversation",posts);
  document.getElementById("userComment").value="";
  if(window.parent!==window){
    window.parent.postMessage({type:"USER_COMMENT",data:txt},"*");
  }
});

// --- Auto-resize iframe ---
function sendHeightToParent(){
  if(window.parent!==window){
    const height = document.body.scrollHeight;
    window.parent.postMessage({type:"IFRAME_HEIGHT",height},"*");
  }
}
sendHeightToParent();
const observer = new MutationObserver(sendHeightToParent);
observer.observe(document.getElementById("conversation"),{childList:true,subtree:true});
</script>
</body>
</html>
